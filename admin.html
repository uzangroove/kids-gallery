<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×’×œ×¨×™×™×ª ×”×™×œ×“×™×</title>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        input[type="text"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus,
        select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10B981;
            color: white;
        }
        
        .btn-danger {
            background: #EF4444;
            color: white;
        }
        
        .btn-secondary {
            background: #6B7280;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: bold;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .preview-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .toast.success { border-left: 4px solid #10B981; }
        .toast.error { border-left: 4px solid #EF4444; }
        .toast.info { border-left: 4px solid #0EA5E9; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¨ × ×™×”×•×œ ×’×œ×¨×™×™×ª ×”×™×œ×“×™×</h1>
            <p class="subtitle">××¢×¨×›×ª × ×™×”×•×œ ××œ××” - ×”×•×¡×¤×”, ×¢×¨×™×›×” ×•××—×™×§×”</p>
        </div>
        
        <!-- Connection Test -->
        <div class="card">
            <h2>ğŸ”Œ ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ-Supabase</h2>
            <div id="connection-status" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f3f4f6;">
                <p style="margin: 0; color: #666;">×‘×•×“×§ ×—×™×‘×•×¨...</p>
            </div>
            <button onclick="testSupabaseConnection()" class="btn btn-secondary">ğŸ”„ ×‘×“×•×§ ×©×•×‘</button>
        </div>
        
        <!-- ×”×•×¡×¤×ª ×™×œ×“ ×—×“×© -->
        <div class="card">
            <h2>â• ×”×•×¡×¤×ª ×™×œ×“ ×—×“×©</h2>
            <form id="add-kid-form">
                <div class="form-group">
                    <label for="kid-name">×©× ×”×™×œ×“ *</label>
                    <input type="text" id="kid-name" required placeholder="×œ×“×•×’××”: ×“× ×™">
                </div>
                
                <div class="form-group">
                    <label for="image-before">×ª××•× ×” ××§×•×¨×™×ª (Before)</label>
                    <input type="file" id="image-before" accept="image/*">
                </div>
                
                <div class="form-group">
                    <label for="image-after">×ª××•× ×” ×ª×œ×ª-××™××“ (After)</label>
                    <input type="file" id="image-after" accept="image/*">
                </div>
                
                <div class="form-group">
                    <label for="video-file">×¡×¨×˜×•×Ÿ</label>
                    <input type="file" id="video-file" accept="video/*">
                </div>
                
                <div id="upload-progress" class="progress-bar" style="display: none;">
                    <div class="progress-fill" style="width: 0%;"></div>
                </div>
                
                <button type="submit" class="btn btn-primary">ğŸ’¾ ×©××•×¨ ×™×œ×“</button>
            </form>
        </div>
        
        <!-- ×”×¢×œ××” ××ª×™×§×™×™×” -->
        <div class="card">
            <h2>ğŸ“‚ ×”×¢×œ××” ××ª×™×§×™×™×ª ××“×™×”</h2>
            <div class="form-group">
                <label>×”×¢×œ×” ×ª×™×§×™×™×” ×©×œ××”</label>
                <input type="file" id="folder-upload" webkitdirectory multiple>
                <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                    ğŸ“Œ ××‘× ×” ×©××•×ª ×§×‘×¦×™×: ×©×.png (before), ×©× ×ª×œ×ª ××™××“.png (after), ×©×.mp4 (video)
                </p>
            </div>
            <button onclick="processFolderUpload()" class="btn btn-success">ğŸ“¤ ×¢×‘×“ ×ª×™×§×™×™×”</button>
        </div>
        
        <!-- ×¨×©×™××ª ×™×œ×“×™× -->
        <div class="card">
            <h2>ğŸ‘¶ ×¨×©×™××ª ×›×œ ×”×™×œ×“×™×</h2>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
            </div>
            <div id="kids-table-container"></div>
        </div>
        
        <!-- ×”×’×“×¨×•×ª ×œ×•×’×•××™× -->
        <div class="card">
            <h2>ğŸ–¼ï¸ ×œ×•×’×•××™×</h2>
            <div class="form-group">
                <label>×œ×•×’×• ×”×’×Ÿ</label>
                <input type="file" id="logo-garden-file" accept="image/*">
                <button onclick="uploadLogo('garden')" class="btn btn-secondary">ğŸ“¤ ×”×¢×œ×”</button>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label>×œ×•×’×• ×¡×‘× ×©××¢×•×Ÿ</label>
                <input type="file" id="logo-personal-file" accept="image/*">
                <button onclick="uploadLogo('personal')" class="btn btn-secondary">ğŸ“¤ ×”×¢×œ×”</button>
            </div>
        </div>
        
        <!-- ×—×–×¨×” ×œ××ª×¨ -->
        <div style="text-align: center; margin-top: 30px;">
            <a href="index.html" class="btn btn-secondary">ğŸ  ×—×–×¨×” ×œ××ª×¨ ×”×¨××©×™</a>
        </div>
    </div>
    
    <script>
        // ==========================================
        // ğŸ”´ ×©×œ×‘ 1: ×”×“×‘×§ ××ª ×”××¤×ª×—×•×ª ×©×œ×š ×-Supabase ×›××Ÿ!
        // ==========================================
        // ××™×š ×œ×§×‘×œ ××ª ×”××¤×ª×—×•×ª:
        // 1. ×›× ×¡ ×œ-supabase.com
        // 2. ×¤×ª×— ××ª ×”×¤×¨×•×™×§×˜ kids-gallery
        // 3. ×œ×—×¥ ×¢×œ Settings (×’×œ×’×œ ×©×™× ×™×™×) â†’ API
        // 4. ×”×¢×ª×§ ××ª Project URL ×•×”-anon public key
        // 5. ×”×“×‘×§ ××•×ª× ×›××Ÿ ×œ××˜×” ×‘××§×•× ×”×˜×§×¡×˜ ×”×¢×‘×¨×™:
        
        const SUPABASE_URL = 'https://zqvxvyvtabnypqgscrat.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpxdnh2eXZ0YWJueXBxZ3NjcmF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MDUyNDIsImV4cCI6MjA4NDM4MTI0Mn0.cj9CCXFtNMyD7sKpu6XatlOyZeLlyHL0ZkfaraIzt_w';
        
        // âš ï¸ ×“×•×’××” ××™×š ×–×” ×¦×¨×™×š ×œ×”×™×¨××•×ª ××—×¨×™ ×”×”×—×œ×¤×”:
       // const SUPABASE_URL = https://zqvxvyvtabnypqgscrat.supabase.co;
// const SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpxdnh2eXZ0YWJueXBxZ3NjcmF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MDUyNDIsImV4cCI6MjA4NDM4MTI0Mn0.cj9CCXFtNMyD7sKpu6XatlOyZeLlyHL0ZkfaraIzt_w;

        // ==========================================
        // ××œ ×ª×©× ×” ×›×œ×•× ××›××Ÿ ×•××™×œ×š!
        // ==========================================
        
        // Initialize Supabase client - ensure it's done after DOM and Supabase library are ready
        let supabaseClient = null;
        
        // Helper function to get supabaseClient safely
        function getSupabaseClient() {
            if (!supabaseClient) {
                throw new Error('Supabase client not initialized. Please wait for the connection test to complete.');
            }
            return supabaseClient;
        }
        
        function initializeSupabase() {
            if (typeof supabase === 'undefined') {
                console.error('Supabase library not loaded yet');
                return false;
            }
            
            // Validate configuration
            const url = String(SUPABASE_URL).trim();
            const key = String(SUPABASE_ANON_KEY).trim();
            
            if (url === '×”×“×‘×§_×›××Ÿ_××ª_×”_PROJECT_URL' || key === '×”×“×‘×§_×›××Ÿ_××ª_×”_ANON_KEY') {
                console.error('Please configure SUPABASE_URL and SUPABASE_ANON_KEY');
                return false;
            }
            
            if (!url || url.length === 0) {
                console.error('SUPABASE_URL is empty');
                return false;
            }
            
            if (!key || key.length === 0) {
                console.error('SUPABASE_ANON_KEY is empty');
                return false;
            }
            
            // Validate URL format
            try {
                const urlObj = new URL(url);
                if (urlObj.protocol !== 'https:' && urlObj.protocol !== 'http:') {
                    console.error('SUPABASE_URL must start with http:// or https://');
                    return false;
                }
            } catch (e) {
                console.error('Invalid SUPABASE_URL format:', e.message);
                console.error('URL provided:', url);
                return false;
            }
            
            try {
                const { createClient } = supabase;
                
                // Log values for debugging (without exposing full key)
                console.log('Initializing Supabase with:');
                console.log('URL:', url);
                console.log('URL length:', url.length);
                console.log('Key length:', key.length);
                console.log('Key starts with:', key.substring(0, 20) + '...');
                
                // Verify URL one more time before creating client
                if (!url || typeof url !== 'string' || url.trim().length === 0) {
                    throw new Error('URL is empty or invalid');
                }
                
                if (!key || typeof key !== 'string' || key.trim().length === 0) {
                    throw new Error('Key is empty or invalid');
                }
                
                supabaseClient = createClient(url.trim(), key.trim());
                console.log('âœ… Supabase client initialized successfully');
                return true;
            } catch (error) {
                console.error('âŒ Error initializing Supabase client:', error);
                console.error('Error details:', {
                    message: error.message,
                    url: url,
                    urlType: typeof url,
                    urlLength: url ? url.length : 0,
                    keyLength: key ? key.length : 0
                });
                return false;
            }
        }
        
        // ==========================================
        // Toast Notifications
        // ==========================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span style="font-size: 1.5rem;">${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-100px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ==========================================
        // Sanitize File Path - Convert Hebrew/Unicode to ASCII-safe
        // ==========================================
        function sanitizePath(path) {
            // Supabase Storage requires ASCII-safe keys
            // We'll use a combination of base64 encoding for non-ASCII parts
            // But keep the structure readable
            
            // Split path into parts (name and extension)
            const parts = path.split('.');
            const extension = parts.length > 1 ? '.' + parts.pop() : '';
            const namePart = parts.join('.');
            
            // Check if name contains non-ASCII characters
            const hasNonASCII = /[^\x00-\x7F]/.test(namePart);
            
            if (hasNonASCII) {
                // Convert Hebrew/Unicode to base64, but keep it readable
                // Use a simple encoding: convert to base64 and replace special chars
                const encoded = btoa(unescape(encodeURIComponent(namePart)))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
                return encoded + extension;
            }
            
            // If already ASCII-safe, return as is
            return path;
        }
        
        // ==========================================
        // File Upload Helper
        // ==========================================
        async function uploadFile(file, path) {
            const client = getSupabaseClient();
            
            // Sanitize the path to ensure it's ASCII-safe
            const sanitizedPath = sanitizePath(path);
            console.log(`Uploading file: ${path} -> ${sanitizedPath}`);
            
            const { data, error } = await client.storage
                .from('kids-media')
                .upload(sanitizedPath, file, { upsert: true });
            
            if (error) {
                console.error('Upload error:', error);
                throw error;
            }
            
            // ×§×‘×œ URL ×¦×™×‘×•×¨×™ - use sanitized path
            const { data: { publicUrl } } = client.storage
                .from('kids-media')
                .getPublicUrl(sanitizedPath);
            
            return publicUrl;
        }
        
        // ==========================================
        // Add Kid Form
        // ==========================================
        function setupAddKidForm() {
            document.getElementById('add-kid-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'ğŸ’¾ ×©×•××¨...';
                
                try {
                    const client = getSupabaseClient();
                    const name = document.getElementById('kid-name').value.trim();
                    const beforeFile = document.getElementById('image-before').files[0];
                    const afterFile = document.getElementById('image-after').files[0];
                    const videoFile = document.getElementById('video-file').files[0];
                    
                    let beforeUrl = null, afterUrl = null, videoUrl = null;
                    
                    // ×”×¢×œ×” ×§×‘×¦×™×
                    if (beforeFile) {
                        beforeUrl = await uploadFile(beforeFile, `${name}_before.${beforeFile.name.split('.').pop()}`);
                    }
                    
                    if (afterFile) {
                        afterUrl = await uploadFile(afterFile, `${name}_after.${afterFile.name.split('.').pop()}`);
                    }
                    
                    if (videoFile) {
                        videoUrl = await uploadFile(videoFile, `${name}_video.${videoFile.name.split('.').pop()}`);
                    }
                    
                    // ×©××•×¨ ×‘×“××˜××‘×™×™×¡
                    const { error } = await client
                        .from('kids')
                        .insert({
                            name: name,
                            image_before: beforeUrl,
                            image_after: afterUrl,
                            video_url: videoUrl
                        });
                    
                    if (error) throw error;
                    
                    showToast(`×”×™×œ×“ ${name} × ×•×¡×£ ×‘×”×¦×œ×—×”!`, 'success');
                    e.target.reset();
                    loadKids();
                    
                } catch (error) {
                    console.error('Error adding kid:', error);
                    let errorMessage = '×©×’×™××” ×‘×”×•×¡×¤×ª ×™×œ×“';
                    if (error.message) {
                        errorMessage += ': ' + error.message;
                    }
                    if (error.status === 401) {
                        errorMessage += ' (×‘×¢×™×™×ª ×”×¨×©××•×ª - ×‘×“×•×§ ××ª ×”-RLS policies ×‘-Supabase)';
                    }
                    if (error.message && error.message.includes('Invalid key')) {
                        errorMessage += ' - ×©× ×”×§×•×‘×¥ ××›×™×œ ×ª×•×•×™× ×œ× ×ª×§×™× ×™×';
                    }
                    showToast(errorMessage, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸ’¾ ×©××•×¨ ×™×œ×“';
                }
            });
        }
        
        // ==========================================
        // Folder Upload
        // ==========================================
        async function processFolderUpload() {
            let client;
            try {
                client = getSupabaseClient();
            } catch (error) {
                showToast('Supabase client not initialized. Please wait for the connection test to complete.', 'error');
                return;
            }
            
            const files = document.getElementById('folder-upload').files;
            if (!files.length) {
                showToast('×‘×—×¨ ×ª×™×§×™×™×” ×ª×—×™×œ×”', 'error');
                return;
            }
            
            showToast('××¢×‘×“ ×ª×™×§×™×™×”... ×–×” ×¢×œ×•×œ ×œ×§×—×ª ×–××Ÿ', 'info');
            
            // ×§×‘×¥ ×§×‘×¦×™× ×œ×¤×™ ×©× ×™×œ×“
            const kidFiles = {};
            
            for (const file of files) {
                const fileName = file.name.toLowerCase();
                const baseName = fileName.split('.')[0].replace(' ×ª×œ×ª ××™××“', '').trim();
                
                if (!kidFiles[baseName]) {
                    kidFiles[baseName] = { name: baseName };
                }
                
                if (fileName.includes('×ª×œ×ª ××™××“')) {
                    kidFiles[baseName].after = file;
                } else if (fileName.endsWith('.mp4')) {
                    kidFiles[baseName].video = file;
                } else if (fileName.endsWith('.png') || fileName.endsWith('.jpg')) {
                    kidFiles[baseName].before = file;
                }
            }
            
            // ×”×¢×œ×” ×›×œ ×™×œ×“
            let count = 0;
            for (const [kidName, files] of Object.entries(kidFiles)) {
                try {
                    let beforeUrl = null, afterUrl = null, videoUrl = null;
                    
                    if (files.before) {
                        beforeUrl = await uploadFile(files.before, `${kidName}_before.${files.before.name.split('.').pop()}`);
                    }
                    if (files.after) {
                        afterUrl = await uploadFile(files.after, `${kidName}_after.${files.after.name.split('.').pop()}`);
                    }
                    if (files.video) {
                        videoUrl = await uploadFile(files.video, `${kidName}_video.${files.video.name.split('.').pop()}`);
                    }
                    
                    await client.from('kids').insert({
                        name: kidName,
                        image_before: beforeUrl,
                        image_after: afterUrl,
                        video_url: videoUrl
                    });
                    
                    count++;
                } catch (error) {
                    console.error(`Error uploading ${kidName}:`, error);
                }
            }
            
            showToast(`×”×•×¢×œ×• ${count} ×™×œ×“×™× ×‘×”×¦×œ×—×”!`, 'success');
            loadKids();
        }
        
        // ==========================================
        // Load Kids Table
        // ==========================================
        async function loadKids() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('kids-table-container');
            
            loading.style.display = 'block';
            container.innerHTML = '';
            
            try {
                const client = getSupabaseClient();
                const { data, error } = await client
                    .from('kids')
                    .select('*')
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">××™×Ÿ ×™×œ×“×™× ×¢×“×™×™×Ÿ. ×”×•×¡×£ ××ª ×”×¨××©×•×Ÿ!</p>';
                    return;
                }
                
                let html = '<table><thead><tr><th>×©×</th><th>×ª××•× ×” ×œ×¤× ×™</th><th>×ª××•× ×” ××—×¨×™</th><th>×•×™×“××•</th><th>×§×™×©×•×¨ ×©×™×ª×•×£</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody>';
                
                // Get base URL for sharing
                const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', 'index.html');
                
                data.forEach(kid => {
                    const shareUrl = `${baseUrl}?kid=${encodeURIComponent(kid.name)}`;
                    // Escape quotes for onclick
                    const escapedUrl = shareUrl.replace(/'/g, "\\'");
                    const escapedName = kid.name.replace(/'/g, "\\'");
                    const escapedId = kid.id.toString().replace(/'/g, "\\'");
                    
                    html += `
                        <tr>
                            <td><strong>${kid.name}</strong></td>
                            <td>${kid.image_before ? '<img src="' + kid.image_before.replace(/'/g, "&#39;") + '" class="preview-img">' : 'âŒ'}</td>
                            <td>${kid.image_after ? '<img src="' + kid.image_after.replace(/'/g, "&#39;") + '" class="preview-img">' : 'âŒ'}</td>
                            <td>${kid.video_url ? 'âœ…' : 'âŒ'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="copyShareLink('${escapedUrl}', '${escapedName}')" style="font-size: 0.9rem; padding: 8px 15px;">ğŸ”— ×”×¢×ª×§ ×§×™×©×•×¨</button>
                                <div style="font-size: 0.75rem; color: #666; margin-top: 5px; word-break: break-all; max-width: 200px;">${shareUrl}</div>
                            </td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteKid('${escapedId}', '${escapedName}')">ğŸ—‘ï¸ ××—×§</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error(error);
                container.innerHTML = `<p style="text-align: center; padding: 40px; color: #EF4444;">âš ï¸ ${error.message}</p>`;
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×™×œ×“×™×: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // ==========================================
        // Copy Share Link
        // ==========================================
        function copyShareLink(url, kidName) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast(`×§×™×©×•×¨ ×©×œ ${kidName} ×”×•×¢×ª×§ ×œ×œ×•×—!`, 'success');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    fallbackCopyShareLink(url, kidName);
                });
            } else {
                fallbackCopyShareLink(url, kidName);
            }
        }
        
        function fallbackCopyShareLink(url, kidName) {
            const textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(`×§×™×©×•×¨ ×©×œ ${kidName} ×”×•×¢×ª×§ ×œ×œ×•×—!`, 'success');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                prompt(`×”×¢×ª×§ ××ª ×”×§×™×©×•×¨ ×©×œ ${kidName}:`, url);
            }
            document.body.removeChild(textArea);
        }
        
        // ==========================================
        // Delete Kid
        // ==========================================
        async function deleteKid(id, name) {
            if (!confirm(`×‘×˜×•×— ×©×¨×•×¦×” ×œ××—×•×§ ××ª ${name}?`)) return;
            
            try {
                const client = getSupabaseClient();
                const { error } = await client
                    .from('kids')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showToast(`${name} × ××—×§ ×‘×”×¦×œ×—×”`, 'success');
                loadKids();
                
            } catch (error) {
                console.error(error);
                showToast('×©×’×™××” ×‘××—×™×§×”', 'error');
            }
        }
        
        // ==========================================
        // Ensure Settings Row Exists
        // ==========================================
        async function ensureSettingsExists() {
            try {
                const client = getSupabaseClient();
                const { data, error: selectError } = await client
                    .from('settings')
                    .select('id')
                    .limit(1)
                    .single();
                
                // If no row exists, create one
                if (selectError || !data) {
                    const { error: insertError } = await client
                        .from('settings')
                        .insert({ logo_garden: null, logo_personal: null });
                    
                    if (insertError) throw insertError;
                }
                return true;
            } catch (error) {
                console.error('Error ensuring settings exists:', error);
                return false;
            }
        }
        
        // ==========================================
        // Upload Logo
        // ==========================================
        async function uploadLogo(type) {
            const fileInput = document.getElementById(`logo-${type}-file`);
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('×‘×—×¨ ×§×•×‘×¥ ×ª×—×™×œ×”', 'error');
                return;
            }
            
            try {
                const client = getSupabaseClient();
                
                // Ensure settings table has a row
                await ensureSettingsExists();
                
                const url = await uploadFile(file, `logo_${type}.${file.name.split('.').pop()}`);
                
                const field = type === 'garden' ? 'logo_garden' : 'logo_personal';
                
                // Get existing settings or create new one
                const { data: existingSettings, error: selectError } = await client
                    .from('settings')
                    .select('id')
                    .limit(1)
                    .single();
                
                let error;
                if (existingSettings && existingSettings.id) {
                    // Update existing row
                    const { error: updateError } = await client
                        .from('settings')
                        .update({ [field]: url })
                        .eq('id', existingSettings.id);
                    error = updateError;
                } else {
                    // Insert new row
                    const { error: insertError } = await client
                        .from('settings')
                        .insert({ [field]: url });
                    error = insertError;
                }
                
                if (error) throw error;
                
                showToast('×œ×•×’×• ×¢×•×“×›×Ÿ!', 'success');
                
            } catch (error) {
                console.error(error);
                showToast('×©×’×™××” ×‘×”×¢×œ××ª ×œ×•×’×•: ' + error.message, 'error');
            }
        }
        
        // ==========================================
        // Test Supabase Connection
        // ==========================================
        async function testSupabaseConnection() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<p style="margin: 0; color: #666;">ğŸ”„ ×‘×•×“×§ ×—×™×‘×•×¨...</p>';
            statusDiv.style.background = '#f3f4f6';
            
            const results = [];
            
            // Test 1: Check if Supabase library is loaded
            if (typeof supabase === 'undefined') {
                results.push({
                    test: '×¡×¤×¨×™×™×ª Supabase',
                    status: 'error',
                    message: 'âŒ ×”×¡×¤×¨×™×™×” ×œ× × ×˜×¢× ×”. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.'
                });
                updateConnectionStatus(statusDiv, results);
                return;
            } else {
                results.push({
                    test: '×¡×¤×¨×™×™×ª Supabase',
                    status: 'success',
                    message: 'âœ… ×”×¡×¤×¨×™×™×” × ×˜×¢× ×” ×‘×”×¦×œ×—×”'
                });
            }
            
            // Test 2: Check configuration
            const url = String(SUPABASE_URL).trim();
            const key = String(SUPABASE_ANON_KEY).trim();
            
            if (url === '×”×“×‘×§_×›××Ÿ_××ª_×”_PROJECT_URL' || key === '×”×“×‘×§_×›××Ÿ_××ª_×”_ANON_KEY') {
                results.push({
                    test: '×§×•× ×¤×™×’×•×¨×¦×™×”',
                    status: 'error',
                    message: 'âŒ ×”××¤×ª×—×•×ª ×œ× ×”×•×’×“×¨×•. ×¢×“×›×Ÿ ××ª SUPABASE_URL ×•-SUPABASE_ANON_KEY'
                });
                updateConnectionStatus(statusDiv, results);
                return;
            }
            
            if (!url || url.length === 0) {
                results.push({
                    test: '×§×•× ×¤×™×’×•×¨×¦×™×”',
                    status: 'error',
                    message: 'âŒ SUPABASE_URL ×¨×™×§'
                });
                updateConnectionStatus(statusDiv, results);
                return;
            }
            
            if (!key || key.length === 0) {
                results.push({
                    test: '×§×•× ×¤×™×’×•×¨×¦×™×”',
                    status: 'error',
                    message: 'âŒ SUPABASE_ANON_KEY ×¨×™×§'
                });
                updateConnectionStatus(statusDiv, results);
                return;
            }
            
            // Validate URL format
            try {
                const urlObj = new URL(url);
                if (urlObj.protocol !== 'https:' && urlObj.protocol !== 'http:') {
                    results.push({
                        test: '×§×•× ×¤×™×’×•×¨×¦×™×”',
                        status: 'error',
                        message: 'âŒ ×”-URL ×—×™×™×‘ ×œ×”×ª×—×™×œ ×‘-http:// ××• https://'
                    });
                    updateConnectionStatus(statusDiv, results);
                    return;
                }
                results.push({
                    test: '×§×•× ×¤×™×’×•×¨×¦×™×”',
                    status: 'success',
                    message: `âœ… URL ×ª×§×™×Ÿ: ${url.substring(0, 40)}...`
                });
            } catch (e) {
                results.push({
                    test: '×§×•× ×¤×™×’×•×¨×¦×™×”',
                    status: 'error',
                    message: `âŒ ×¤×•×¨××˜ URL ×œ× ×ª×§×™×Ÿ: ${e.message}`
                });
                updateConnectionStatus(statusDiv, results);
                return;
            }
            
            // Test 3: Initialize client
            try {
                if (!supabaseClient) {
                    if (!initializeSupabase()) {
                        results.push({
                            test: '××ª×—×•×œ ×œ×§×•×—',
                            status: 'error',
                            message: 'âŒ ×©×’×™××” ×‘××ª×—×•×œ ×”×œ×§×•×—'
                        });
                        updateConnectionStatus(statusDiv, results);
                        return;
                    }
                }
                // Try to get client to verify it works
                getSupabaseClient();
                results.push({
                    test: '××ª×—×•×œ ×œ×§×•×—',
                    status: 'success',
                    message: 'âœ… ×”×œ×§×•×— ××•×ª×—×œ ×‘×”×¦×œ×—×”'
                });
            } catch (error) {
                results.push({
                    test: '××ª×—×•×œ ×œ×§×•×—',
                    status: 'error',
                    message: `âŒ ×©×’×™××”: ${error.message}`
                });
                updateConnectionStatus(statusDiv, results);
                return;
            }
            
            // Test 4: Test database connection (try to query kids table)
            try {
                const client = getSupabaseClient();
                const { data, error } = await client
                    .from('kids')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    results.push({
                        test: '×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™×',
                        status: 'error',
                        message: `âŒ ×©×’×™××”: ${error.message}`
                    });
                } else {
                    results.push({
                        test: '×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™×',
                        status: 'success',
                        message: 'âœ… ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™× ×¢×•×‘×“'
                    });
                }
            } catch (error) {
                results.push({
                    test: '×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™×',
                    status: 'error',
                    message: `âŒ ×©×’×™××”: ${error.message}`
                });
            }
            
            // Test 5: Test storage access
            try {
                const client = getSupabaseClient();
                const { data, error } = await client
                    .storage
                    .from('kids-media')
                    .list('', { limit: 1 });
                
                if (error) {
                    results.push({
                        test: '×’×™×©×” ×œ××—×¡×•×Ÿ',
                        status: 'error',
                        message: `âŒ ×©×’×™××”: ${error.message}`
                    });
                } else {
                    results.push({
                        test: '×’×™×©×” ×œ××—×¡×•×Ÿ',
                        status: 'success',
                        message: 'âœ… ×’×™×©×” ×œ××—×¡×•×Ÿ ×¢×•×‘×“×ª'
                    });
                }
            } catch (error) {
                results.push({
                    test: '×’×™×©×” ×œ××—×¡×•×Ÿ',
                    status: 'error',
                    message: `âŒ ×©×’×™××”: ${error.message}`
                });
            }
            
            updateConnectionStatus(statusDiv, results);
        }
        
        function updateConnectionStatus(statusDiv, results) {
            const allSuccess = results.every(r => r.status === 'success');
            const hasError = results.some(r => r.status === 'error');
            
            let html = '<div style="line-height: 1.8;">';
            results.forEach(result => {
                const color = result.status === 'success' ? '#10B981' : '#EF4444';
                html += `<p style="margin: 5px 0; color: ${color};"><strong>${result.test}:</strong> ${result.message}</p>`;
            });
            html += '</div>';
            
            if (allSuccess) {
                statusDiv.style.background = '#d1fae5';
                html += '<p style="margin-top: 10px; color: #10B981; font-weight: bold;">âœ… ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”!</p>';
            } else if (hasError) {
                statusDiv.style.background = '#fee2e2';
                html += '<p style="margin-top: 10px; color: #EF4444; font-weight: bold;">âŒ ×™×© ×‘×¢×™×•×ª ×‘×—×™×‘×•×¨. ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ ×œ×¤×¨×˜×™× × ×•×¡×¤×™×.</p>';
            }
            
            statusDiv.innerHTML = html;
        }
        
        // ==========================================
        // Initialize
        // ==========================================
        // Wait for DOM and Supabase library to be ready
        function waitForSupabase(maxAttempts = 30, attempt = 0) {
            // Check if Supabase library is loaded and has createClient method
            if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                if (initializeSupabase()) {
                    setupAddKidForm();
                    loadKids();
                    // Run connection test automatically after initialization
                    setTimeout(() => testSupabaseConnection(), 500);
                } else {
                    showToast('×©×’×™××” ×‘××ª×—×•×œ Supabase. ×‘×“×•×§ ××ª ×”×§×•× ×¤×™×’×•×¨×¦×™×”.', 'error');
                    setTimeout(() => testSupabaseConnection(), 500);
                }
            } else if (attempt < maxAttempts) {
                // Wait a bit longer on first attempts, then check more frequently
                const delay = attempt < 5 ? 200 : 100;
                setTimeout(() => waitForSupabase(maxAttempts, attempt + 1), delay);
            } else {
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª Supabase. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.', 'error');
                setTimeout(() => testSupabaseConnection(), 500);
            }
        }
        
        function initApp() {
            waitForSupabase();
        }
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // DOM is already ready
            initApp();
        }
    </script>
</body>
</html>
